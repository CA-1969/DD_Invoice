<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dream Destination - GST Travel Invoice</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
  :root { --radius:13px; }
  body {
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    margin:0; background: linear-gradient(120deg, #dbeafe 0%, #e0f2fe 100%);
    min-height:100vh;
  }
  .invoice-card {
    max-width:1040px; margin:32px auto 0 auto; background: #fff;
    border-radius:var(--radius); box-shadow:0 4px 25px #a0aec03a, 0 1.5px 20px #dbeafead;
    padding:37px 20px 35px 20px;
    border:1.3px solid #e5eaf3;
  }
  .firmhdr { text-align:center; font-family:'Poppins',sans-serif; font-size:32px; font-weight:700; color:#1e3362; letter-spacing:.7px; }
  .firminfo { text-align:center; font-size:18px; color:#47506e; margin-bottom:10px; line-height:1.4; }
  .headerlabel { text-align:center; font-size:19px; font-weight:500; color:#6b7280; margin:3px 0 18px 0; letter-spacing:.5px;}
  label, input, textarea, th, td, select { font-size: 17px; }
  input, textarea, select {
    border:1.5px solid #b6c6d8; background:#f5f8fa; border-radius:5px; padding:5px 8px;
    transition:.13s;
  }
  input:focus, textarea:focus, select:focus { border-color:#4683e6; background:#e7f1fd; }
  input[type="number"] { width:92px; text-align:right;}
  .scroll-table-wrapper {
    overflow-x:auto; width:100%;
    margin-bottom: 19px;
    background: #f5fafd; border-radius:8px;
  }
  table {
    min-width:1260px; width:100%; border-collapse: separate; border-spacing:0;
    border-radius: var(--radius); background: #f8fafd;
    box-shadow:0 1.5px 10px #c5d7f142;
  }
  th, td { border:1px solid #bac8da; padding:8px 10px; }
  th {
    background: linear-gradient(90deg,#e3ebfa 60%, #e8f1fb 100%); font-weight:700; color:#293855;
    border-top:2px solid #24384177;
    letter-spacing:.2px;
    white-space:nowrap;
  }
  .right { text-align:right; }
  .center { text-align:center; }
  .actions-bar {
    display: flex; flex-wrap:wrap; gap:18px; justify-content: flex-end;
    margin-bottom:13px; margin-top:-18px; background: none;
  }
  .actbtn {
    font-size:16px; font-family:'Inter',sans-serif; padding:7px 20px; font-weight:600; color:#fff;
    border:none; border-radius:7px; box-shadow: 0 1.5px 10px #e0e7ff66; cursor:pointer; transition:.17s;
    margin-top:7px;
  }
  .act-add     { background: linear-gradient(90deg,#256ad6 40%,#4085e9 100%);}
  .act-prev    { background: #38497B;}
  .act-amend   { background: #f59e42;}
  .act-cancel  { background: #d7454f;}
  .act-delete  { background: #6c6c6c;}
  .linebtn {
    padding: 3px 13px;
    font-size:22px; font-weight:700; color:#346; background:#e9efff; border-radius:5px; border:none; cursor:pointer; margin:0 2px;
  }
  .linebtn:active { color:#0f4a8a;}
  .footerNote { font-size:14px; color:#666; text-align:center; padding-bottom:7px;}
  .gst-row {margin-top:2px; margin-bottom:18px; display:flex; gap:23px; justify-content:left;}
  .cancelled-invoice {
    position: fixed; left:0; right:0; top:44%; text-align:center; font-size:66px; color:#ff3747;
    font-weight:800; opacity:0.13; transform:rotate(-10deg); z-index:99; pointer-events:none;
  }
  .tcboxlbl {font-weight:600; margin-left:18px;font-size:18px;}
  .tcboxlbl input[type=checkbox] { transform: scale(1.17);}
  #onlySCGSTToggle,#tcsToggle { accent-color:#3156c1; vertical-align:middle;}
  th:first-child, td:first-child { border-left-width:2px; border-radius:8px 0 0 8px; }
  th:last-child, td:last-child { border-right-width:2px; border-radius:0 8px 8px 0; }
  tr .row-actions { min-width:66px; }
  th:nth-child(10), td:nth-child(10) { min-width:90px !important; }
  @media (max-width:1200px) {
    .scroll-table-wrapper {overflow-x:auto;}
    table {min-width:1200px;}
  }
  @media (max-width:900px) {
    .invoice-card { padding:7px 1vw;}
  }
  @media print {
    .actions-bar, .desc-expander, .footerNote, .cancelled-invoice, .gst-row, #tcboxWrap, #retrievePrev, .linebtn { display:none !important; }
    input, textarea { border:none !important; background:none !important;}
    th, td { font-size: 16px; }
    body { background:none; }
    table {box-shadow:none;}
    .invoice-card {box-shadow:none; border:none;}
  }
</style>
</head>
<body>
<div class="invoice-card">
  <div class="actions-bar">
    <button class="actbtn act-add"    onclick="newInvoice()">Add</button>
    <button class="actbtn act-prev"   onclick="loadPreviousInvoice()">Previous</button>
    <button class="actbtn act-amend"  onclick="alert('Amend via DB soon')">Amend</button>
    <button class="actbtn act-cancel" onclick="cancelInvoice()">Cancel</button>
    <button class="actbtn act-delete" onclick="alert('Delete via DB soon')">Delete</button>
  </div>
  <div class="firmhdr">Dream Destination</div>
  <div class="firminfo">
    Shop no. 17, Krishna Complex, Court Road, Saharanpur 247001<br>
    GSTIN: <b>09AGYPM6575C2ZO</b> &nbsp; | &nbsp; State: Uttar Pradesh (09)<br>
    Email: info@dreamdestination.org
  </div>
  <div class="headerlabel">GST Tax Invoice</div>

  <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; margin-bottom:14px;">
    <label><b>Invoice No</b> <input type="text" id="invoiceNumber" readonly style="min-width:120px"></label>
    <label><b>Date</b> <input type="date" id="invoiceDate" style="min-width:140px"></label>
    <label><b>Tour ID</b> <input type="text" id="tourId" placeholder="(prefilled or from Payment)" style="min-width:108px"></label>
    <span id="retrievePrev" style="margin-left:auto;">
      <button type="button"
        style="padding:6px 18px; background:#4062e8;color:#fff;border-radius:5px;font-weight:500;cursor:pointer;"
        onclick="showPreviousInvoice()">Show Previous Invoice</button>
    </span>
  </div>

  <div style="margin-bottom:8px;">
    <label><b>Bill To:</b> <input type="text" id="recipientName" placeholder="Name"></label>
    <label><b>Address:</b> <input type="text" id="recipientAddress"></label>
    <label><b>GSTIN/UIN:</b> <input type="text" id="recipientGSTIN"></label>
  </div>
  <div style="margin-bottom:16px;">
    <label><b>Place of Supply (State/Code):</b> <input type="text" id="placeOfSupply" value="Uttar Pradesh, 09"></label>
    <label><b>Delivery Address (if different):</b> <input type="text" id="deliveryAddress"></label>
  </div>

  <form id="invoiceForm" autocomplete="off">
    <div class="scroll-table-wrapper">
    <table id="itemsTable">
      <thead>
        <tr>
          <th class="center">#</th>
          <th>Description<br><span style="font-weight:normal">(expand for details)</span></th>
          <th>HSN/SAC</th>
          <th>Qty/UQC</th>
          <th>Rate (₹)</th>
          <th>Disc. (₹)</th>
          <th>Taxable Value (₹)</th>
          <th>CGST %</th>
          <th>SGST %</th>
          <th>IGST %</th>
          <th class="row-actions"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
  </form>

  <div id="tcboxWrap" style="margin-bottom:15px;display:flex;align-items:center;">
    <label class="tcboxlbl"><input type="checkbox" id="onlySCGSTToggle"> GST on Service Charges Only</label>
    <span style="color:#7c88a5; font-size:15px; margin-left:18px;">
      (Tick for GST on only Service Charges, untick to charge on total)
    </span>
  </div>
  <div style="margin-bottom:8px;">
    <label class="tcboxlbl"><input type="checkbox" id="tcsToggle"> Apply TCS @ 5%</label>
    <span style="color:#6c7891; font-size:14px; margin-left:10px;">(When checked, TCS will be added below)</span>
  </div>

  <div class="gst-row">
    <label><b>CGST%</b> <input type="number" id="defCgst" value="2.5" step="0.01"></label>
    <label><b>SGST%</b> <input type="number" id="defSgst" value="2.5" step="0.01"></label>
    <label><b>IGST%</b> <input type="number" id="defIgst" value="0" step="0.01"></label>
  </div>

  <table>
    <tr><td class="right no-border bold">Cost of Tour (A):</td>
        <td><input type="text" id="tourSubtotal" class="right bold" readonly></td></tr>
    <tr><td class="right no-border bold">Service Charges (B):</td>
        <td><input type="text" id="serviceSubtotal" class="right bold" readonly></td></tr>
    <tr><td class="right no-border">CGST (as per GST logic):</td>
        <td><input type="text" id="totalCGST" class="right" readonly></td></tr>
    <tr><td class="right no-border">SGST (as per GST logic):</td>
        <td><input type="text" id="totalSGST" class="right" readonly></td></tr>
    <tr><td class="right no-border">IGST (as per GST logic):</td>
        <td><input type="text" id="totalIGST" class="right" readonly></td></tr>
    <tr><td class="right bold no-border">Grand Total (A+B+GST):</td>
        <td><input type="text" id="grandTotal" class="right bold" readonly></td></tr>
    <tr id="tcsLine" style="display:none;"><td class="right bold no-border" style="color:#045;">TCS @ 5% of Grand Total:</td>
        <td><input type="text" id="tcs5" class="right bold" readonly style="color:#046;"></td></tr>
    <tr id="tcsTotalLine" style="display:none;"><td class="right bold no-border" style="color:#045;">Total with TCS:</td>
        <td><input type="text" id="totalWithTcs" class="right bold" readonly style="color:#046;"></td></tr>
  </table>

  <div style="margin-bottom:8px;">
    <label>
      <input type="checkbox" id="reverseCharge"> Tax payable on reverse charge
    </label>
    &nbsp;&nbsp;
    <label>
      <input type="checkbox" id="signatureAttested"> Signed (Supplier/Authorized Rep.)
    </label>
  </div>
  <div class="footerNote">
    GST Invoice for Dream Destination — GST logic as per checkbox.<br/>Print or Save as PDF with Ctrl+P.
  </div>
  <div id="cancelWatermark" class="cancelled-invoice" style="display:none">CANCELLED</div>
  <template id="descFormTmpl">
    <div class="descform">
      <div class="explabel">Advance: <input type="number" name="advance" step="0.01" min="0"></div>
      <div class="explabel">Hotel Land Part: <input type="number" name="hotelLand" step="0.01" min="0"></div>
      <div class="explabel">Sight Seeing: <input type="number" name="sightseeing" step="0.01" min="0"></div>
      <div class="explabel">Transfers: <input type="number" name="transfers" step="0.01" min="0"></div>
      <div class="explabel">
        Air Ticket:
        <span>
          From <input type="text" name="from" style="width:50px;">
          To <input type="text" name="to" style="width:50px;">
          Amount <input type="number" name="airFare" step="0.01" min="0">
        </span>
      </div>
      <div class="explabel">Visa Charges: <input type="number" name="visa" step="0.01" min="0"></div>
      <div class="explabel">Others: <input type="number" name="others" step="0.01" min="0"></div>
      <div class="explabel" style="font-weight:600;">Service Charges
        <input type="number" name="serviceCharge" step="0.01" min="0" style="font-weight:700;">
      </div>
      <div class="explabel" style="align-items:flex-start;">
        Narration/Notes: <textarea name="narration" rows="2" style="width:246px;"></textarea>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="saveDesc(this)">OK</button>
        <button type="button" onclick="cancelDesc(this)">Cancel</button>
      </div>
    </div>
  </template>
</div>
<script>
// Invoice/serial logic
function currentFY() { let dt=new Date(),m=dt.getMonth()+1,yr=dt.getFullYear(); return (m>=4)?(yr.toString().slice(-2)+'-'+(yr+1).toString().slice(-2)):( (yr-1).toString().slice(-2)+'-'+yr.toString().slice(-2) ); }
function getLastSerial() { return +(localStorage.getItem('dd_invoice_serial_'+currentFY())||0);}
function nextSerial() { let last=getLastSerial()+1; return {serial:"DD/"+currentFY()+"/"+String(last).padStart(4,'0'), idx:last}; }
function updateSerialInStorage(idx){ localStorage.setItem('dd_invoice_serial_'+currentFY(), idx);}
function setInvoiceNumber(serialOverride) {
  let info = serialOverride ? {serial:serialOverride, idx:parseInt(serialOverride.split('/').pop())||1 } : nextSerial();
  document.getElementById('invoiceNumber').value = info.serial; updateSerialInStorage(info.idx); window._lastInvoiceNo = info.serial;
}
function resetFields() {
  document.getElementById('invoiceForm').reset(); document.getElementById('recipientName').value='';
  document.getElementById('recipientAddress').value=''; document.getElementById('recipientGSTIN').value='';
  document.getElementById('placeOfSupply').value="Uttar Pradesh, 09"; document.getElementById('deliveryAddress').value='';
  document.getElementById('reverseCharge').checked=false; document.getElementById('signatureAttested').checked=false;
  let tb=document.getElementById('itemsTable').getElementsByTagName('tbody')[0]; tb.innerHTML='';
  addRow();
  document.getElementById('invoiceDate').valueAsDate = new Date(); document.getElementById('cancelWatermark').style.display='none';
  setEditability && setEditability(true);
}
function newInvoice() { setInvoiceNumber && setInvoiceNumber(); resetFields && resetFields(); updateTotals(); setTimeout(expandDescAllRows, 200);}
function cancelInvoice() {document.getElementById('cancelWatermark').style.display='';setEditability && setEditability(false);}
function loadPreviousInvoice(){ alert('Previous Invoice will load when DB integrated');}
function setEditability(isEditable) {
  let flds=document.querySelectorAll('#invoiceForm input, #invoiceForm textarea, #recipientName, #recipientAddress, #recipientGSTIN, #placeOfSupply, #deliveryAddress, #defCgst, #defSgst, #defIgst');
  for(let f of flds){if(f.id==='invoiceNumber'||f.id==='invoiceDate') continue;f.readOnly = !isEditable;f.disabled=!isEditable;}
  document.querySelectorAll('.row-actions button').forEach(but=>but.disabled = !isEditable);
  document.querySelectorAll('.desc-expander').forEach(but=>but.disabled = !isEditable);
}
document.getElementById('tcsToggle').addEventListener('change', function() {
  showHideTcsLines(); updateTotals();
});
function showHideTcsLines() {
  const show = document.getElementById('tcsToggle').checked;
  document.getElementById('tcsLine').style.display = show ? '' : 'none';
  document.getElementById('tcsTotalLine').style.display = show ? '' : 'none';
}
function updateTotals() {
  let tb=document.getElementById('itemsTable').getElementsByTagName('tbody')[0],
      costOfTour=0, serviceCharges=0, base=0, cgst=0, sgst=0, igst=0;
  for(let tr of tb.rows){
    costOfTour += Number(tr.getAttribute('data-tourtotal'))||0;
    serviceCharges += Number(tr.getAttribute('data-servicecharge'))||0;
  }
  if(document.getElementById('onlySCGSTToggle').checked){
    base=serviceCharges; cgst=base*0.09; sgst=base*0.09; igst=0;
  } else{
    base=costOfTour+serviceCharges;
    let r=+document.getElementById('defCgst').value||0, s=+document.getElementById('defSgst').value||0, i=+document.getElementById('defIgst').value||0;
    cgst=base*r/100; sgst=base*s/100; igst=base*i/100;
  }
  const grandTotal = +(costOfTour+serviceCharges+cgst+sgst+igst);
  document.getElementById('tourSubtotal').value=costOfTour.toFixed(2);
  document.getElementById('serviceSubtotal').value=serviceCharges.toFixed(2);
  document.getElementById('totalCGST').value = cgst.toFixed(2);
  document.getElementById('totalSGST').value = sgst.toFixed(2);
  document.getElementById('totalIGST').value = igst.toFixed(2);
  document.getElementById('grandTotal').value = grandTotal.toFixed(2);
  if (document.getElementById('tcsToggle').checked) {
    const tcs = +(grandTotal*0.05);
    const withTcs = grandTotal + tcs;
    document.getElementById('tcs5').value = tcs.toFixed(2);
    document.getElementById('totalWithTcs').value = withTcs.toFixed(2);
  } else {
    document.getElementById('tcs5').value = '';
    document.getElementById('totalWithTcs').value = '';
  }
  setRatesToAllRows && setRatesToAllRows();
}
function expandDescAllRows() {
  let rows = document.querySelectorAll('#itemsTable tbody tr');
  for (let row of rows) {
    let btn = row.querySelector('.desc-expander');
    if (btn) btn.click();
  }
}
function addRow(service, nIdx) {
  let t=document.getElementById('itemsTable').getElementsByTagName('tbody')[0],
      idx=nIdx!=null?nIdx:t.rows.length+1;
  let row=t.insertRow(idx-1);
  let descShort=service&&service.descShort?service.descShort:'';
  row.innerHTML =
    `<td class="center">${idx}</td>
    <td>
      <input type="text" readonly name="descShort" value="${descShort||''}" placeholder="(Click to expand)" onclick="expandDesc(this)">
      <button type="button" class="desc-expander" onclick="expandDesc(this)">Expand/Edit</button>
      <div class="descDetail"></div>
    </td>
    <td><input type="text" name="hsn" value="${service?service.hsn||'9985':''}"></td>
    <td><input type="number" name="qty" value="${service?service.qty||1:1}" min="1" style="width:36px;">
        <input type="text" name="uqc" value="${service?service.uqc||'Unit':'Unit'}" style="width:38px;"></td>
    <td><input type="number" name="rate" value="${service?service.rate||0:0}" min="0" class="right"></td>
    <td><input type="number" name="disc" value="${service?service.disc||0:0}" class="right" min="0"></td>
    <td><input type="number" name="tvalue" readonly value="${service?service.tvalue||'0.00':'0.00'}" class="right"></td>
    <td><input type="number" name="cgst" value="${service?service.cgst||document.getElementById('defCgst').value:document.getElementById('defCgst').value}" class="right"></td>
    <td><input type="number" name="sgst" value="${service?service.sgst||document.getElementById('defSgst').value:document.getElementById('defSgst').value}" class="right"></td>
    <td><input type="number" name="igst" value="${service?service.igst||document.getElementById('defIgst').value:document.getElementById('defIgst').value}" class="right"></td>
    <td class="row-actions center">
      <button type="button" class="linebtn" title="+ Row" onclick="addRow()">&plus;</button>
      <button type="button" class="linebtn" title="- Row" onclick="deleteRow(this)">&minus;</button>
    </td>`;
  attachListeners(row);
  setTimeout(function() {row.querySelector('.desc-expander').click()},140);
  updateTotals();
}
function deleteRow(btn){
  let row=btn.closest('tr'),tb=row.parentNode;
  if(tb.rows.length>1){ tb.removeChild(row); updateTotals();}
}
function attachListeners(row){
  let ins=row.querySelectorAll('input[type="number"], input[type="text"]');
  ins.forEach(inp=>inp.oninput=updateTotals);
}
function expandDesc(btn){
  let td=btn.closest('td'),descArea=td.querySelector('.descDetail');
  if(td.querySelector('.descform')) return;
  const tmpl=document.getElementById('descFormTmpl').content.cloneNode(true);
  let shortInp=td.querySelector('input[name="descShort"]');
  let data=shortInp.dataset.fullDesc?JSON.parse(shortInp.dataset.fullDesc):{};
  for(let k in data) if(tmpl.querySelector(`[name="${k}"]`)) tmpl.querySelector(`[name="${k}"]`).value = data[k];
  descArea.innerHTML=''; descArea.appendChild(tmpl);
}
function saveDesc(btn){
  let parent=btn.closest('.descform'), td=parent.closest('td');
  let obj={}, tourTotal=0, serviceCharge=0;
  ['advance','hotelLand','sightseeing','transfers','airFare','visa','others'].forEach(k=>{
    let v = parent.querySelector(`input[name="${k}"]`); obj[k]=v?v.value:0;
    tourTotal += Number(obj[k]||0);
  });
  let svc=parent.querySelector('input[name="serviceCharge"]');
  serviceCharge=svc?Number(svc.value)||0:0; obj.serviceCharge=serviceCharge;
  obj.narration = parent.querySelector('textarea[name="narration"]').value;
  obj.from = parent.querySelector('input[name="from"]').value;
  obj.to = parent.querySelector('input[name="to"]').value;
  let summary=[];
  if(obj.advance && +obj.advance) summary.push('Advance: ₹'+(+obj.advance).toLocaleString());
  if(obj.hotelLand && +obj.hotelLand) summary.push('Hotel/Land: ₹'+(+obj.hotelLand).toLocaleString());
  if(obj.sightseeing && +obj.sightseeing) summary.push('Sightseeing: ₹'+(+obj.sightseeing).toLocaleString());
  if(obj.transfers && +obj.transfers) summary.push('Transfers: ₹'+(+obj.transfers).toLocaleString());
  if(obj.airFare && +obj.airFare) summary.push('Air: '+(obj.from||'')+'-'+(obj.to||'')+' ₹'+(+obj.airFare).toLocaleString());
  if(obj.visa && +obj.visa) summary.push('Visa: ₹'+(+obj.visa).toLocaleString());
  if(obj.others && +obj.others) summary.push('Other: ₹'+(+obj.others).toLocaleString());
  if(serviceCharge) summary.push('**Service Charges: ₹'+serviceCharge.toLocaleString()+"**");
  if(obj.narration) summary.push('Note: '+obj.narration);
  td.querySelector('input[name="descShort"]').value = summary.join(' | ');
  td.querySelector('input[name="descShort"]').dataset.fullDesc = JSON.stringify(obj);
  td.querySelector('.descDetail').innerHTML = '';
  let tr = td.closest('tr');
  tr.setAttribute('data-tourtotal',tourTotal||0);
  tr.setAttribute('data-servicecharge',serviceCharge||0);
  tr.querySelector('input[name="tvalue"]').value = (tourTotal+serviceCharge).toFixed(2);
  updateTotals();
}
function cancelDesc(btn){ btn.closest('.descform').remove();}
window.onload=function(){
  setInvoiceNumber && setInvoiceNumber();
  document.getElementById('invoiceDate').valueAsDate = new Date();
  addRow();
  setEditability && setEditability(true);
  prefillFromLocalStorageOrURL && prefillFromLocalStorageOrURL();
  updateTotals();
  showHideTcsLines();
  setTimeout(expandDescAllRows, 200);
};
</script>
</body>
</html>
