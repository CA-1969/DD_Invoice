<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dream Destination - GST Travel Invoice</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
  :root { --radius:13px; }
  body {
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    margin:0; background: linear-gradient(120deg, #dbeafe 0%, #e0f2fe 100%);
    min-height:100vh;
  }
  .invoice-card {
    max-width:1060px; margin:32px auto 0 auto; background: #fff;
    border-radius:var(--radius); box-shadow:0 4px 25px #a0aec03a, 0 1.5px 20px #dbeafead;
    padding:37px 20px 35px 20px;
    border:1.3px solid #e5eaf3;
    position: relative;
    overflow: visible;
  }
  .firmhdr { text-align:center; font-family:'Poppins',sans-serif; font-size:32px; font-weight:700; color:#1e3362; letter-spacing:.7px; }
  .firminfo { text-align:center; font-size:18px; color:#47506e; margin-bottom:10px; line-height:1.4; }
  .headerlabel { text-align:center; font-size:19px; font-weight:500; color:#6b7280; margin:3px 0 18px 0; letter-spacing:.5px;}
  label, input, textarea, th, td, select { font-size: 17px; }
  input, textarea, select {
    border:1.5px solid #b6c6d8; background:#f5f8fa; border-radius:5px; padding:5px 8px;
    transition:.13s;
  }
  input:focus, textarea:focus, select:focus { border-color:#4683e6; background:#e7f1fd; }
  input[type="number"], .smallnum { max-width: 107px; width: 95px !important; text-align:right;}
  .widerfield { min-width:170px !important; width:225px !important; }
  .midfield { min-width:135px !important; width:160px !important; }
  .scroll-table-wrapper {
    overflow-x:auto; width:100%;
    margin-bottom: 19px;
    background: #f5fafd; border-radius:8px;
  }
  table {
    min-width:1160px; width:100%; border-collapse: separate; border-spacing:0;
    border-radius: var(--radius); background: #f8fafd;
    box-shadow:0 1.5px 10px #c5d7f142;
  }
  th, td { border:1px solid #bac8da; padding:7px 4px; }
  th {
    background: linear-gradient(90deg,#e3ebfa 60%, #e8f1fb 100%); font-weight:700; color:#293855;
    border-top:2px solid #24384177;
    letter-spacing:.2px;
    white-space:nowrap;
  }
  .right { text-align:right; }
  .center { text-align:center; }
  .actions-bar {
    display: flex; flex-wrap:wrap; gap:17px; justify-content: flex-start;
    margin-bottom:13px; margin-top:-18px; background: none;
    align-items:center;
  }
  .actbtn {
    font-size:16px; font-family:'Inter',sans-serif; padding:7px 20px; font-weight:600; color:#fff;
    border:none; border-radius:7px; box-shadow: 0 1.5px 10px #e0e7ff66; cursor:pointer; transition:.17s;
    margin-top:7px;
  }
  .act-add     { background: linear-gradient(90deg,#256ad6 40%,#4085e9 100%);}
  .act-prev    { background: #38497b;}
  .act-amend   { background: #f59e42;}
  .act-cancel  { background: #d7454f;}
  .act-delete  { background: #6c6c6c;}
  .act-showinv { background: #3f5fff;}
  .linebtn {
    padding:2px 11px;
    font-size:20px; font-weight:700; color:#346; background:#e9efff; border-radius:5px; border:none; cursor:pointer; margin:0 2px;
  }
  .linebtn:active { color:#0f4a8a;}
  .footerNote { font-size:14px; color:#666; text-align:center; padding-bottom:7px;}
  .gst-row {margin-top:2px; margin-bottom:18px; display:flex; gap:23px; justify-content:left;}
  .cancelled-invoice {
    position: absolute; left:0; right:0; top:190px; text-align:center; font-size:70px;
    color:#cc2d2d; font-weight:900; opacity:0.13; transform:rotate(-14deg); z-index:999; pointer-events:none; user-select:none;
    width:100%; pointer-events:none;
  }
  .tcboxlbl {font-weight:600; margin-left:18px;font-size:18px;}
  .tcboxlbl input[type=checkbox] { transform: scale(1.17);}
  #onlySCGSTToggle,#tcsToggle { accent-color:#3156c1; vertical-align:middle;}
  th:first-child, td:first-child { border-left-width:2px; border-radius:8px 0 0 8px; }
  th:last-child, td:last-child { border-right-width:2px; border-radius:0 8px 8px 0; }
  tr .row-actions { min-width:56px;}
  th:nth-child(10), td:nth-child(10) { min-width:72px !important; }
  .totals-table {
    width:100%;
    max-width:540px;
    min-width: 1px;
    margin-bottom: 4px;
    background: #f8fafd;
    border-radius:13px;
    margin-top:14px;
    box-shadow:0 1.5px 10px #c5d7f12c;
  }
  .totals-table td { border:1px solid #bac8da; }
  .totals-table input[type="text"] {
    width:98px; min-width:58px; max-width:122px;
    margin-left:5px; margin-right:3px;
    display:inline-block;
  }
  @media (max-width:720px) {
    .invoice-card { padding:2vw 1vw;}
    .totals-table { max-width:99vw; }
    .totals-table input[type="text"] { width:88px;}
  }
  @media (max-width:1200px) {
    .scroll-table-wrapper {overflow-x:auto;}
    table {min-width:920px;}
  }
  @media print {
    .actions-bar, .desc-expander, .footerNote, .cancelled-invoice, .gst-row, #tcboxWrap, .linebtn, .act-showinv { display:none !important; }
    input, textarea { border:none !important; background:none !important;}
    th, td { font-size: 16px; }
    body { background:none; }
    table {box-shadow:none;}
    .invoice-card {box-shadow:none; border:none;}
  }
</style>
</head>
<body>
<div class="invoice-card">
  <div class="actions-bar">
    <button class="actbtn act-add"    onclick="newInvoice()">Add</button>
    <button class="actbtn act-prev"   onclick="loadPreviousInvoice()">Previous</button>
    <button class="actbtn act-amend"  onclick="alert('Amend via DB soon')">Amend</button>
    <button class="actbtn act-cancel" onclick="cancelInvoice()">Cancel</button>
    <button class="actbtn act-delete" onclick="alert('Delete via DB soon')">Delete</button>
    <button class="actbtn act-showinv" onclick="showPreviousInvoice()">Show Previous Invoice</button>
  </div>
  <div class="firmhdr">Dream Destination</div>
  <div class="firminfo">
    Shop no. 17, Krishna Complex, Court Road, Saharanpur 247001<br>
    GSTIN: <b>09AGYPM6575C2ZO</b> &nbsp; | &nbsp; State: Uttar Pradesh (09)<br>
    Email: info@dreamdestination.org
  </div>
  <div class="headerlabel">GST Tax Invoice</div>

  <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; margin-bottom:14px;">
    <label><b>Invoice No</b> <input type="text" id="invoiceNumber" readonly class="midfield"></label>
    <label><b>Date</b> <input type="date" id="invoiceDate" class="midfield"></label>
    <label><b>Tour ID</b> <input type="text" id="tourId" placeholder="(prefilled or from Payr)" class="midfield"></label>
  </div>

  <div style="margin-bottom:8px;">
    <label><b>Bill To:</b> <input type="text" id="recipientName" placeholder="Name"></label>
    <label><b>Address:</b> <input type="text" id="recipientAddress" class="widerfield"></label>
    <label><b>GSTIN/UIN:</b> <input type="text" id="recipientGSTIN"></label>
  </div>
  <div style="margin-bottom:16px;">
    <label><b>Place of Supply (State/Code):</b> <input type="text" id="placeOfSupply" value="Uttar Pradesh, 09"></label>
    <label><b>Delivery Address (if different):</b> <input type="text" id="deliveryAddress"></label>
  </div>

  <form id="invoiceForm" autocomplete="off">
    <div class="scroll-table-wrapper">
    <table id="itemsTable">
      <thead>
        <tr>
          <th class="center">#</th>
          <th>Description<br><span style="font-weight:normal">(expand for details)</span></th>
          <th>HSN/SAC</th>
          <th>Qty/UQC</th>
          <th>Rate (₹)</th>
          <th>Disc. (₹)</th>
          <th>Taxable Value (₹)</th>
          <th>CGST %</th>
          <th>SGST %</th>
          <th>IGST %</th>
          <th class="row-actions"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
  </form>

  <div id="tcboxWrap" style="margin-bottom:15px;display:flex;align-items:center;">
    <label class="tcboxlbl"><input type="checkbox" id="onlySCGSTToggle"> GST on Service Charges Only</label>
    <span style="color:#7c88a5; font-size:15px; margin-left:18px;">
      (Tick for GST on only Service Charges, untick to charge on total)
    </span>
  </div>
  <div style="margin-bottom:8px;">
    <label class="tcboxlbl"><input type="checkbox" id="tcsToggle"> Apply TCS @ 5%</label>
    <span style="color:#6c7891; font-size:14px; margin-left:10px;">(When checked, TCS will be added below)</span>
  </div>

  <div class="gst-row">
    <label><b>CGST%</b> <input type="number" id="defCgst" value="2.5" step="0.01" class="smallnum"></label>
    <label><b>SGST%</b> <input type="number" id="defSgst" value="2.5" step="0.01" class="smallnum"></label>
    <label><b>IGST%</b> <input type="number" id="defIgst" value="0" step="0.01" class="smallnum"></label>
  </div>
  <table class="totals-table">
    <tr><td class="right no-border bold">Cost of Tour (A):</td>
        <td><input type="text" id="tourSubtotal" class="right bold" readonly></td></tr>
    <tr><td class="right no-border bold">Service Charges (B):</td>
        <td><input type="text" id="serviceSubtotal" class="right bold" readonly></td></tr>
    <tr><td class="right no-border">CGST (as per GST logic):</td>
        <td><input type="text" id="totalCGST" class="right" readonly></td></tr>
    <tr><td class="right no-border">SGST (as per GST logic):</td>
        <td><input type="text" id="totalSGST" class="right" readonly></td></tr>
    <tr><td class="right no-border">IGST (as per GST logic):</td>
        <td><input type="text" id="totalIGST" class="right" readonly></td></tr>
    <tr><td class="right bold no-border">Grand Total (A+B+GST):</td>
        <td><input type="text" id="grandTotal" class="right bold" readonly></td></tr>
    <tr id="tcsLine" style="display:none;"><td class="right bold no-border" style="color:#045;">TCS @ 5% of Grand Total:</td>
        <td><input type="text" id="tcs5" class="right bold" readonly style="color:#046;"></td></tr>
    <tr id="tcsTotalLine" style="display:none;"><td class="right bold no-border" style="color:#045;">Total with TCS:</td>
        <td><input type="text" id="totalWithTcs" class="right bold" readonly style="color:#046;"></td></tr>
  </table>

  <div style="margin-bottom:8px;">
    <label>
      <input type="checkbox" id="reverseCharge"> Tax payable on reverse charge
    </label>
    &nbsp;&nbsp;
    <label>
      <input type="checkbox" id="signatureAttested"> Signed (Supplier/Authorized Rep.)
    </label>
  </div>
  <div class="footerNote">
    GST Invoice for Dream Destination — GST logic as per checkbox.<br/>Print or Save as PDF with Ctrl+P.
  </div>
  <div id="cancelWatermark" class="cancelled-invoice" style="display:none">CANCELLED</div>
  <template id="descFormTmpl">
    <div class="descform">
      <div class="explabel">Advance: <input type="number" name="advance" step="0.01" min="0"></div>
      <div class="explabel">Hotel Land Part: <input type="number" name="hotelLand" step="0.01" min="0"></div>
      <div class="explabel">Sight Seeing: <input type="number" name="sightseeing" step="0.01" min="0"></div>
      <div class="explabel">Transfers: <input type="number" name="transfers" step="0.01" min="0"></div>
      <div class="explabel">
        Air Ticket:
        <span>
          From <input type="text" name="from" style="width:50px;">
          To <input type="text" name="to" style="width:50px;">
          Amount <input type="number" name="airFare" step="0.01" min="0">
        </span>
      </div>
      <div class="explabel">Visa Charges: <input type="number" name="visa" step="0.01" min="0"></div>
      <div class="explabel">Others: <input type="number" name="others" step="0.01" min="0"></div>
      <div class="explabel" style="font-weight:600;">Service Charges
        <input type="number" name="serviceCharge" step="0.01" min="0" style="font-weight:700;">
      </div>
      <div class="explabel" style="align-items:flex-start;">
        Narration/Notes: <textarea name="narration" rows="2" style="width:246px;"></textarea>
      </div>
      <div style="text-align:right;">
        <button type="button" onclick="saveDesc(this)">OK</button>
        <button type="button" onclick="cancelDesc(this)">Cancel</button>
      </div>
    </div>
  </template>
</div>
<script>
// --- All prior invoice logic, UI event handlers, and updateTotals as above. ---
// --- NOW: New true sequential "Previous" navigation logic (uses localStorage) ---

// Array of all saved invoices (in localStorage under 'dd_invoice_history')
let CURRENT_HISTORY_INDEX = null;

function saveInvoiceToHistory() {
  // Grab all form fields and lines; save to localStorage array
  const invoice = {
    invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
    invoiceDate: document.getElementById('invoiceDate').value,
    tourId: document.getElementById('tourId').value,
    recipientName: document.getElementById('recipientName').value,
    recipientAddress: document.getElementById('recipientAddress').value,
    recipientGSTIN: document.getElementById('recipientGSTIN').value,
    placeOfSupply: document.getElementById('placeOfSupply').value,
    deliveryAddress: document.getElementById('deliveryAddress').value,
    reverseCharge: document.getElementById('reverseCharge').checked,
    signatureAttested: document.getElementById('signatureAttested').checked,
    onlySCGST: document.getElementById('onlySCGSTToggle').checked,
    tcs: document.getElementById('tcsToggle').checked,
    cgst: document.getElementById('defCgst').value,
    sgst: document.getElementById('defSgst').value,
    igst: document.getElementById('defIgst').value,
    items: [],
    totals: {
      tourSubtotal: document.getElementById('tourSubtotal').value,
      serviceSubtotal: document.getElementById('serviceSubtotal').value,
      totalCGST: document.getElementById('totalCGST').value,
      totalSGST: document.getElementById('totalSGST').value,
      totalIGST: document.getElementById('totalIGST').value,
      grandTotal: document.getElementById('grandTotal').value,
      tcs5: document.getElementById('tcs5').value,
      totalWithTcs: document.getElementById('totalWithTcs').value
    }
  };
  Array.from(document.querySelectorAll("#itemsTable tbody tr")).forEach(tr=>{
    const td2 = tr.cells[1];
    invoice.items.push({
      descShort: td2.querySelector('input[name="descShort"]').value,
      descData: td2.querySelector('input[name="descShort"]').dataset.fullDesc||"",
      hsn: tr.querySelector('input[name="hsn"]').value,
      qty: tr.querySelector('input[name="qty"]').value,
      uqc: tr.querySelector('input[name="uqc"]').value,
      rate: tr.querySelector('input[name="rate"]').value,
      disc: tr.querySelector('input[name="disc"]').value,
      tvalue: tr.querySelector('input[name="tvalue"]').value,
      cgst: tr.querySelector('input[name="cgst"]').value,
      sgst: tr.querySelector('input[name="sgst"]').value,
      igst: tr.querySelector('input[name="igst"]').value,
      dataTourTotal: tr.getAttribute('data-tourtotal'),
      dataServiceCharge: tr.getAttribute('data-servicecharge')
    });
  });
  // Store
  let hist = JSON.parse(localStorage.getItem('dd_invoice_history')||'[]');
  hist.push(invoice);
  localStorage.setItem('dd_invoice_history',JSON.stringify(hist));
  CURRENT_HISTORY_INDEX = hist.length-1;
}

// On every add, save to history
function newInvoice() {
  saveInvoiceToHistory();
  setInvoiceNumber && setInvoiceNumber(); resetFields && resetFields(); updateTotals(); setTimeout(expandDescAllRows, 200);
  // Current index is incremented
  let hist = JSON.parse(localStorage.getItem('dd_invoice_history')||'[]');
  CURRENT_HISTORY_INDEX = hist.length-1;
}

function loadPreviousInvoice() {
  // Load the last saved (not currently displayed) invoice
  let hist = JSON.parse(localStorage.getItem('dd_invoice_history')||'[]');
  if(hist.length<1) return alert('No saved invoices in browser storage!');
  CURRENT_HISTORY_INDEX = CURRENT_HISTORY_INDEX==null?hist.length-1:CURRENT_HISTORY_INDEX-1;
  if(CURRENT_HISTORY_INDEX<0) CURRENT_HISTORY_INDEX = 0;
  const invoice = hist[CURRENT_HISTORY_INDEX];
  if(!invoice) { alert('No previous invoice!'); return;}
  // fill fields:
  document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
  document.getElementById('invoiceDate').value = invoice.invoiceDate;
  document.getElementById('tourId').value = invoice.tourId;
  document.getElementById('recipientName').value = invoice.recipientName;
  document.getElementById('recipientAddress').value = invoice.recipientAddress;
  document.getElementById('recipientGSTIN').value = invoice.recipientGSTIN;
  document.getElementById('placeOfSupply').value = invoice.placeOfSupply;
  document.getElementById('deliveryAddress').value = invoice.deliveryAddress;
  document.getElementById('reverseCharge').checked = invoice.reverseCharge;
  document.getElementById('signatureAttested').checked = invoice.signatureAttested;
  document.getElementById('onlySCGSTToggle').checked = invoice.onlySCGST;
  document.getElementById('tcsToggle').checked = invoice.tcs;
  document.getElementById('defCgst').value = invoice.cgst;
  document.getElementById('defSgst').value = invoice.sgst;
  document.getElementById('defIgst').value = invoice.igst;
  // repopulate items
  let tb=document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
  tb.innerHTML='';
  invoice.items.forEach((item,k)=>{
    addRow();
    let tr=tb.rows[k];
    let td2 = tr.cells[1];
    td2.querySelector('input[name="descShort"]').value = item.descShort;
    td2.querySelector('input[name="descShort"]').dataset.fullDesc = item.descData;
    tr.querySelector('input[name="hsn"]').value = item.hsn;
    tr.querySelector('input[name="qty"]').value = item.qty;
    tr.querySelector('input[name="uqc"]').value = item.uqc;
    tr.querySelector('input[name="rate"]').value = item.rate;
    tr.querySelector('input[name="disc"]').value = item.disc;
    tr.querySelector('input[name="tvalue"]').value = item.tvalue;
    tr.querySelector('input[name="cgst"]').value = item.cgst;
    tr.querySelector('input[name="sgst"]').value = item.sgst;
    tr.querySelector('input[name="igst"]').value = item.igst;
    tr.setAttribute('data-tourtotal',item.dataTourTotal||'0');
    tr.setAttribute('data-servicecharge',item.dataServiceCharge||'0');
  });
  // Fill summary
  document.getElementById('tourSubtotal').value=invoice.totals.tourSubtotal;
  document.getElementById('serviceSubtotal').value=invoice.totals.serviceSubtotal;
  document.getElementById('totalCGST').value = invoice.totals.totalCGST;
  document.getElementById('totalSGST').value = invoice.totals.totalSGST;
  document.getElementById('totalIGST').value = invoice.totals.totalIGST;
  document.getElementById('grandTotal').value = invoice.totals.grandTotal;
  document.getElementById('tcs5').value = invoice.totals.tcs5;
  document.getElementById('totalWithTcs').value = invoice.totals.totalWithTcs;
  hideCancelWatermark && hideCancelWatermark();
  updateTotals();
  setTimeout(expandDescAllRows, 99);
}
// The rest of your previous script unchanged...
function showPreviousInvoice(){
  hideCancelWatermark && hideCancelWatermark();
  alert("This would fetch a selected invoice by Tour ID when integrated with Sheet.");
}
/* ...include all prior UI update logic, updateTotals, etc. from previous code... */
</script>
</body>
</html>
