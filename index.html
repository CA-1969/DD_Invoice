<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dream Destination - GST Travel Invoice</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
  :root { --radius:12px; }
  body {
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    margin:24px; background: linear-gradient(120deg, #e0e7ff 0%, #e6f4ff 100%);
    min-height: 100vh;
  }
  .invoice-card {
    max-width:980px; margin:24px auto 0 auto; background: #fff; 
    border-radius:var(--radius); box-shadow:0 4px 25px #a0aec03a, 0 1.5px 20px #dbeafe89;
    padding:35px 32px 35px 32px;
    border:1.3px solid #e5eaf3;
  }
  .firmhdr { text-align:center; font-family:'Poppins',sans-serif; font-size:32px; font-weight:700; color:#1e3362; letter-spacing:.7px; }
  .firminfo { text-align:center; font-size:18px; color:#47506e; margin-bottom:10px; line-height:1.4; }
  .headerlabel { text-align:center; font-size:19px; font-weight:500; color:#6b7280; margin:3px 0 18px 0; letter-spacing:.5px;}
  label, input, textarea, th, td, select { font-size: 17px; }
  input, textarea, select {
    border:1.5px solid #b6c6d8; background:#f5f8fa; border-radius:5px; padding:5px 8px;
    transition:.15s;
  }
  input:focus, textarea:focus, select:focus { border-color:#4f75cb; background:#eaf1f8; }
  input[type="number"] { width:92px; text-align:right;}
  table {
    width:100%; border-collapse: separate; border-spacing:0; margin-bottom: 22px;
    border-radius: var(--radius); overflow: hidden; background: #f8fafd;
    box-shadow:0 1.5px 10px #c5d7f142;
  }
  th, td { border:1px solid #bac8da; padding:8px 10px; }
  th {
    background: linear-gradient(90deg,#e3ebfa 60%, #e8f1fb 100%); font-weight:700; color:#293855;
    border-top:2px solid #24384177;
    letter-spacing:.3px;
  }
  .right { text-align:right; }
  .center { text-align:center; }
  .desc-expander {
    font-size:14px; color:#3676ea; background:none; border:none; cursor:pointer; text-decoration:underline; font-weight:500; }
  .descform { background:#f1f5fa; border:1.5px solid #b5c7e2; margin:8px 0; padding:17px 23px; border-radius:9px;}
  .explabel { min-width:185px; display:flex; align-items:center; justify-content:space-between; }
  .explabel input { width:110px;}
  .row-actions { white-space:nowrap; }
  .actions { position: absolute; top:28px; right:24px; z-index:2; display:flex; gap:14px;}
  .actions button {
    font-size:15px; min-width:90px; padding:6px 16px; border:none; border-radius:6px;
    box-shadow: 0 1px 7px #f3f7ff; color:white; font-weight:600; cursor:pointer; transition:.19s;
  }
  #addBtn    { background: linear-gradient(90deg,#256ad6 40%,#4085e9 100%);}
  #prevBtn   { background: #38497B;}
  #amendBtn  { background: #FF9800;}
  #cancelBtn { background: #D32F2F;}
  #deleteBtn { background: #666;}
  #addBtn:hover    { background:#1755b8; }
  #prevBtn:hover   { background:#2a365c;}
  #amendBtn:hover  { background:#94560a;}
  #cancelBtn:hover { background:#991a1a;}
  #deleteBtn:hover { background:#393939;}
  .footerNote { font-size:14px; color:#666; text-align:center; padding-bottom:7px;}
  .gst-row {margin-top:2px; margin-bottom:18px; display:flex; gap:23px; justify-content:left;}
  .cancelled-invoice {
    position: fixed; left:0; right:0; top:44%; text-align:center; font-size:66px; color:#ff3747;
    font-weight:800; opacity:0.13; transform:rotate(-10deg); z-index:99; pointer-events:none;
  }
  .tcboxlbl {font-weight:600; margin-left:18px;font-size:18px;}
  .tcboxlbl input[type=checkbox] { transform: scale(1.17);}
  #onlySCGSTToggle { accent-color:#3156c1; vertical-align:middle;}
  th:first-child, td:first-child { border-left-width:2px; border-radius:8px 0 0 8px; }
  th:last-child, td:last-child { border-right-width:2px; border-radius:0 8px 8px 0; }
  th:nth-child(10), td:nth-child(10) { min-width: 90px !important; }
  ::selection { background: #bbf7f8;}
  @media print {
    .actions, .desc-expander, .footerNote, .cancelled-invoice, .gst-row, #tcboxWrap, #retrievePrev { display:none !important; }
    input, textarea { border:none !important; background:none !important;}
    th, td { font-size: 16px; }
    body { background:none; }
    table {box-shadow:none;}
    .invoice-card {box-shadow:none; border:none;}
  }
</style>
</head>
<body>
<div class="invoice-card">
<!-- Action Buttons (not printed) -->
<div class="actions" id="actButtons">
  <button id="addBtn"    onclick="newInvoice()">Add</button>
  <button id="prevBtn"   onclick="loadPreviousInvoice()">Previous</button>
  <button id="amendBtn"  onclick="alert('Amend via DB soon')">Amend</button>
  <button id="cancelBtn" onclick="cancelInvoice()">Cancel</button>
  <button id="deleteBtn" onclick="alert('Delete via DB soon')">Delete</button>
</div>

<div class="firmhdr">Dream Destination</div>
<div class="firminfo">
  Shop no. 17, Krishna Complex, Court Road, Saharanpur 247001<br>
  GSTIN: <b>09AGYPM6575C2</b> &nbsp; | &nbsp; State: Uttar Pradesh (09)<br>
  Email: info@dreamdestination.org
</div>
<div class="headerlabel">GST Tax Invoice</div>

<div style="display:flex; align-items:center; gap:23px; justify-content:flex-start; margin-bottom:14px;">
  <label><b>Invoice No</b> <input type="text" id="invoiceNumber" readonly></label>
  <label><b>Date</b> <input type="date" id="invoiceDate"></label>
  <label><b>Tour ID</b> <input type="text" id="tourId" placeholder="(prefilled or from Payment)"></label>
  <span id="retrievePrev"><button type="button" style="padding:4px 14px;margin-left:10px;background:#4f5eb6;color:#fff;border-radius:5px;font-weight:500;cursor:pointer;" onclick="showPreviousInvoice()">Show Previous Invoice</button></span>
</div>

<div style="margin-bottom:8px;">
  <label><b>Bill To:</b> <input type="text" id="recipientName" placeholder="Name"></label>
  <label><b>Address:</b> <input type="text" id="recipientAddress"></label>
  <label><b>GSTIN/UIN:</b> <input type="text" id="recipientGSTIN"></label>
</div>
<div style="margin-bottom:16px;">
  <label><b>Place of Supply (State/Code):</b> <input type="text" id="placeOfSupply" value="Uttar Pradesh, 09"></label>
  <label><b>Delivery Address (if different):</b> <input type="text" id="deliveryAddress"></label>
</div>

<form id="invoiceForm">
  <table id="itemsTable">
    <thead>
      <tr>
        <th width="35" class="center">#</th>
        <th>Description<br><span style="font-weight:normal">(expand for details)</span></th>
        <th width="70">HSN/SAC</th>
        <th width="75">Qty/UQC</th>
        <th width="90">Rate (₹)</th>
        <th width="90">Disc. (₹)</th>
        <th width="104">Taxable Value (₹)</th>
        <th width="68">CGST %</th>
        <th width="68">SGST %</th>
        <th width="90">IGST %</th>
        <th class="row-actions"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</form>

<!-- GST Logic toggling UI -->
<div id="tcboxWrap" style="margin-bottom:15px;display:flex;align-items:center;">
  <label class="tcboxlbl"><input type="checkbox" id="onlySCGSTToggle"> GST on Service Charges Only</label>
  <span style="color:#7c88a5; font-size:15px; margin-left:18px;">
    (Tick for GST on only Service Charges, untick to charge on total)
  </span>
</div>

<div class="gst-row">
  <label><b>CGST%</b> <input type="number" id="defCgst" value="2.5" step="0.01"></label>
  <label><b>SGST%</b> <input type="number" id="defSgst" value="2.5" step="0.01"></label>
  <label><b>IGST%</b> <input type="number" id="defIgst" value="0" step="0.01"></label>
</div>

<table>
  <tr><td class="right no-border bold">Cost of Tour (A):</td>
      <td><input type="text" id="tourSubtotal" class="right bold" readonly></td></tr>
  <tr><td class="right no-border bold">Service Charges (B):</td>
      <td><input type="text" id="serviceSubtotal" class="right bold" readonly></td></tr>
  <tr><td class="right no-border">CGST (as per GST logic):</td>
      <td><input type="text" id="totalCGST" class="right" readonly></td></tr>
  <tr><td class="right no-border">SGST (as per GST logic):</td>
      <td><input type="text" id="totalSGST" class="right" readonly></td></tr>
  <tr><td class="right no-border">IGST (as per GST logic):</td>
      <td><input type="text" id="totalIGST" class="right" readonly></td></tr>
  <tr><td class="right bold no-border">Grand Total (A+B+GST):</td>
      <td><input type="text" id="grandTotal" class="right bold" readonly></td></tr>
</table>

<div style="margin-bottom:8px;">
  <label>
    <input type="checkbox" id="reverseCharge"> Tax payable on reverse charge
  </label>
  &nbsp;&nbsp;
  <label>
    <input type="checkbox" id="signatureAttested"> Signed (Supplier/Authorized Rep.)
  </label>
</div>
<div class="footerNote">
  GST Invoice for Dream Destination — GST logic as per checkbox.<br/>Print or Save as PDF with Ctrl+P.
</div>
<div id="cancelWatermark" class="cancelled-invoice" style="display:none">CANCELLED</div>

<template id="descFormTmpl">
  <div class="descform">
    <div class="explabel">Advance: <input type="number" name="advance" step="0.01" min="0"></div>
    <div class="explabel">Hotel Land Part: <input type="number" name="hotelLand" step="0.01" min="0"></div>
    <div class="explabel">Sight Seeing: <input type="number" name="sightseeing" step="0.01" min="0"></div>
    <div class="explabel">Transfers: <input type="number" name="transfers" step="0.01" min="0"></div>
    <div class="explabel">
      Air Ticket:
      <span>
        From <input type="text" name="from" style="width:50px;">
        To <input type="text" name="to" style="width:50px;">
        Amount <input type="number" name="airFare" step="0.01" min="0">
      </span>
    </div>
    <div class="explabel">Visa Charges: <input type="number" name="visa" step="0.01" min="0"></div>
    <div class="explabel">Others: <input type="number" name="others" step="0.01" min="0"></div>
    <div class="explabel" style="font-weight:600;">Service Charges
      <input type="number" name="serviceCharge" step="0.01" min="0" style="font-weight:700;">
    </div>
    <div class="explabel" style="align-items:flex-start;">
      Narration/Notes: <textarea name="narration" rows="2" style="width:246px;"></textarea>
    </div>
    <div style="text-align:right;">
      <button type="button" onclick="saveDesc(this)">OK</button>
      <button type="button" onclick="cancelDesc(this)">Cancel</button>
    </div>
  </div>
</template>

<script>
// Prefill logic from localStorage (auto-clears)
function getUrlParam(name) {
    let params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
}
function prefillFromLocalStorageOrURL() {
    try {
      let prefill = JSON.parse(localStorage.getItem('dd_invoice_prefill') || '{}');
      if (prefill.tourId || getUrlParam('tourId')) document.getElementById('tourId').value = prefill.tourId || getUrlParam('tourId');
      if (prefill.travelerName || getUrlParam('tname')) document.getElementById('recipientName').value = prefill.travelerName || getUrlParam('tname');
      if (prefill.amount || getUrlParam('amt')) {
        setTimeout(() => {
           let row = document.querySelector('#itemsTable tbody tr');
           if (row && !row.getAttribute('data-prefilled')) {
              expandDesc(row.querySelector('button.desc-expander'));
              setTimeout(()=> {
                let svc = document.querySelector('.descform input[name="serviceCharge"]');
                if(svc && !svc.value) {
                  svc.value = prefill.amount || getUrlParam('amt');
                  document.querySelector('.descform button[onclick^=saveDesc]').click();
                  row.setAttribute('data-prefilled','1');
                }
              },190);
           }
        },240);
      }
      if (prefill.otherDetails || getUrlParam('details'))
        document.getElementById('recipientAddress').value = prefill.otherDetails || getUrlParam('details');
    } catch (e) {}
    localStorage.removeItem('dd_invoice_prefill');
}
// === "Show Previous Invoice" stub for demonstration ===
function showPreviousInvoice() {
    let tid = document.getElementById('tourId').value.trim();
    if(!tid) { alert('Enter Tour ID to retrieve invoice.'); return; }
    alert('This would fetch the latest invoice by Tour ID = "'+tid+'" (feature: to be added with Google Sheets)');
}
// === ...(All your robust DD_Invoice logic from previous versions goes here, unchanged) ===
function currentFY() { let dt=new Date(),m=dt.getMonth()+1,yr=dt.getFullYear(); return (m>=4)?(yr.toString().slice(-2)+'-'+(yr+1).toString().slice(-2)):( (yr-1).toString().slice(-2)+'-'+yr.toString().slice(-2) ); }
function getLastSerial() { return +(localStorage.getItem('dd_invoice_serial_'+currentFY())||0);}
function nextSerial() { let last=getLastSerial()+1; return {serial:"DD/"+currentFY()+"/"+String(last).padStart(4,'0'), idx:last}; }
function updateSerialInStorage(idx){ localStorage.setItem('dd_invoice_serial_'+currentFY(), idx);}
function setInvoiceNumber(serialOverride) {
  let info = serialOverride ? {serial:serialOverride, idx:parseInt(serialOverride.split('/').pop())||1 } : nextSerial();
  document.getElementById('invoiceNumber').value = info.serial; updateSerialInStorage(info.idx); window._lastInvoiceNo = info.serial;
}
function resetFields() {
  document.getElementById('invoiceForm').reset(); document.getElementById('recipientName').value='';
  document.getElementById('recipientAddress').value=''; document.getElementById('recipientGSTIN').value='';
  document.getElementById('placeOfSupply').value="Uttar Pradesh, 09"; document.getElementById('deliveryAddress').value='';
  document.getElementById('reverseCharge').checked=false; document.getElementById('signatureAttested').checked=false;
  let tb=document.getElementById('itemsTable').getElementsByTagName('tbody')[0]; tb.innerHTML=''; addRow();
  document.getElementById('invoiceDate').valueAsDate = new Date(); document.getElementById('cancelWatermark').style.display='none';
}
function newInvoice() { setInvoiceNumber(); resetFields(); setEditability(true); updateTotals();}
function cancelInvoice() {document.getElementById('cancelWatermark').style.display='';setEditability(false);}
function loadPreviousInvoice(){ alert('Previous Invoice will load when DB integrated');}
function setEditability(isEditable) {
  let flds=document.querySelectorAll('#invoiceForm input, #invoiceForm textarea, #recipientName, #recipientAddress, #recipientGSTIN, #placeOfSupply, #deliveryAddress, #defCgst, #defSgst, #defIgst');
  for(let f of flds){if(f.id==='invoiceNumber'||f.id==='invoiceDate') continue;f.readOnly = !isEditable;f.disabled=!isEditable;}
  document.querySelectorAll('.row-actions button').forEach(but=>but.disabled = !isEditable);
  document.querySelectorAll('.desc-expander').forEach(but=>but.disabled = !isEditable);
}
// ...[Grid, modal, calculation, GST/SGST linkage - unchanged logic from your last robust version]...
let cgstInp = document.getElementById('defCgst'), sgstInp = document.getElementById('defSgst');
function mirrorRate(val){ cgstInp.value=val; sgstInp.value=val; }
cgstInp.addEventListener('input',function(){
  if(!document.getElementById('onlySCGSTToggle').checked){ mirrorRate(this.value);}
  updateTotals();
});
sgstInp.addEventListener('input',function(){
  if(!document.getElementById('onlySCGSTToggle').checked){ mirrorRate(this.value);}
  updateTotals();
});
document.getElementById('defIgst').addEventListener('input',updateTotals);

document.getElementById('onlySCGSTToggle').addEventListener('change',function(){
  if(this.checked){
    mirrorRate(9.00);
    cgstInp.readOnly=sgstInp.readOnly=true;
    cgstInp.style.background='#e5eefd'; sgstInp.style.background='#e5eefd';
    document.getElementById('defIgst').value=0; document.getElementById('defIgst').readOnly=true; document.getElementById('defIgst').style.background='#ececec';
  } else{
    cgstInp.readOnly=sgstInp.readOnly=false;
    cgstInp.style.background=sgstInp.style.background='#fff';
    document.getElementById('defIgst').readOnly=false; document.getElementById('defIgst').style.background='#fff';
    mirrorRate(cgstInp.value); //reset mirror if you untick
  }
  setRatesToAllRows(); updateTotals();
});
function setRatesToAllRows(){
  Array.from(document.querySelectorAll('#itemsTable tbody tr')).forEach(tr=>{
    tr.querySelector('[name="cgst"]').value = cgstInp.value;
    tr.querySelector('[name="sgst"]').value = sgstInp.value;
    tr.querySelector('[name="igst"]').value = document.getElementById('defIgst').value;
  });
}
// [The rest of your grid row, description modal, VAT/calc logic (unchanged from your latest robust version), plus...]
window.onload=function(){ setInvoiceNumber(); document.getElementById('invoiceDate').valueAsDate = new Date();
  addRow(); setEditability(true); prefillFromLocalStorageOrURL(); updateTotals(); };
</script>
</div>
</body>
</html>
